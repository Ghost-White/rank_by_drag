<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <title>使用顺延的方式排序</title>
    <link rel="stylesheet" type="text/css" href="css/main.css">
    <script type="text/javascript" src="js/main.js"></script>
</head>
<body>
    <div class="main">
        <div class="upload_img">
            <div class="upload_button">
                <input type="file" id="files" multiple size="10" onchange="fileChange()" />
                点击这里上传图片
            </div>
            <p>使用顺延的方式排序</p>            
        </div>
        <ul id="result" class="error result"></ul>      
    </div>
</body>
<script type="text/javascript" src="js/main.js"></script>
<script type="text/javascript">
    var result = document.getElementById("result");
    var count = 0;
    if(typeof FileReader == 'undefined') {
        result.innerHTML = "抱歉，你的浏览器不支持预览";
    }

    var files = document.getElementById("files");

    function fileChange(){
        readFiles(files,result);
        var timer = setInterval(function(){
            if(result.getElementsByTagName("li").length==files.files.length){
                /*depatch the events here !*/
                var lis = document.querySelectorAll('#result li');
                [].forEach.call(lis, function(li) {
                  li.querySelectorAll('img')[0].addEventListener('dragstart', handleDragStart, false);
                  li.querySelectorAll('img')[0].addEventListener('dragenter', handleDragEnter, false);
                  li.querySelectorAll('img')[0].addEventListener('dragover', handleDragOver, false);
                  li.querySelectorAll('img')[0].addEventListener('dragleave', handleDragLeave, false);
                  li.querySelectorAll('img')[0].addEventListener('drop',handleDrop,false);
                });
                clearInterval(timer);
            }
        },10);
    }
    var parentNode = document.getElementById("result");

    function readFiles(files,target){
        target.innerHTML = '';
        var img_length = files.files.length;
        var i = 0;
        for(var simpleFile of files.files){           
            if(simpleFile == undefined){
                target.innerHTML = "请先选择要上传的图片！";
            }
            if(!/image\/\w+/.test(simpleFile.type)) {
                alert("请确保文件类型为图片");
                return false;
            }
            var reader = new FileReader();
            reader.readAsDataURL(simpleFile);
            reader.onload = function(e){    
               target.innerHTML += '<li id="drag_'+i+'"><img draggable="true" src="'+this.result+'" alt=""/></li>';
               i++;
            }
        }
    }

    var src_id = null,
        tar_id = null;

    function set_src_id(id){
        src_id = id;
    }

    function get_src_id(){
        return src_id;
    }

    function handleDragStart(ev){  /*这里的 ev.target指的是最开始触发事件的元素<img>，因为事件冒泡，使得其父元素的事件处理函数来处理该事件*/
        ev.dataTransfer.effectAllowed='move';
        ev.dataTransfer.setData("SRC_ID",ev.target.parentNode.getAttribute('id'));
        set_src_id(ev.target.parentNode.getAttribute('id'));
        ev.dataTransfer.setDragImage(ev.target,100,100); /*使得拖拽过程中鼠标在图像左上角*/
        return false;
    }

    function handleDragOver(ev) {   /*dragover 事件会在鼠标悬停在上方时不断启动*/
        ev.preventDefault();    /*允许放置*/
        return false;
    }

    function handleDragLeave(ev){
        /*ev.target.parentNode.classList.remove('over');*/
        return false;
    }

    function handleDrop(ev) {
        /*ev.target.parentNode.classList.remove('over');*/ 
        ev.preventDefault();    /*可以放置*/
        var tar = ev.target.parentNode;
        var src = document.getElementById(ev.dataTransfer.getData('SRC_ID'));
        return false;
    }

    function handleDragEnter(ev){       /*无法获取 dataTransfer 的数据，只能通过全局变量保存数据*/ 
        
        var tar_id = ev.target.parentNode.getAttribute('id'),
            src_id = get_src_id();

        if(tar_id !== src_id){
            var tar = ev.target.parentNode,
                parent = tar.parentNode,
                src = document.getElementById(src_id);

/*            var parent_width = parent.offsetWidth,
                src_width = src.offsetWidth,
                src_hight = src.offsetHeight;*/

            console.log('enter:'+ev.target.parentNode.getAttribute('id'));

            var src_index = getChildrenIndex(src),
                tar_index = getChildrenIndex(tar);

            /*var transform_arr = new Array();
            if(src_index > tar_index){
                for(var i = tar_index;i<src_index;i++){
                    var node = parent.childNodes[i],
                        t_left = 0,
                        t_top = 0,
                        next_node = node.nextElementSibling;
                    if(node.offsetLeft<=node.nextElementSibling.offsetLeft){
                        t_left = src_width;
                    }else{
                        t_left = next_node.offsetLeft - node.offsetLeft;
                        t_top = next_node.offsetTop - node.offsetTop;
                    }
                    var element = {
                        node:node,
                        t_left:t_left,
                        t_top:t_top
                    }
                    transform_arr.push(element);      //后移
                }
                element = {
                    node:src,
                    t_left:tar.offsetLeft - src.offsetLeft,
                    t_top:tar.offsetTop - src.offsetTop
                }
                transform_arr.push(element);
            }else if(src_index < tar_index){
                var whole_width = 0;
                for(var j = src_index+1;j<tar_index+1;j++){
                    var node = parent.childNodes[j],
                        t_left = 0,
                        t_top = 0,
                        pre_node = node.previousElementSibling
                    if(node.offsetLeft>=pre_node.offsetLeft){
                        t_left = src_width;
                    }else{
                        t_left = (pre_node.offsetLeft - src_width + pre_node.offsetWidth) - node.offsetLeft;
                        t_top = pre_node.offsetTop - node.offsetTop;
                    }
                    var element = {
                        node:node,
                        t_left:t_left,
                        t_top:t_top
                    }
                    transform_arr.push(parent.childNodes[i]);       //前移
                }
                element = {
                    node:src,
                    t_left:
                }

            }else{
                return;
            }*/

            
            var src_left_old = src.offsetLeft,
                src_top_old = src.offsetTop,
                tar_left_old = tar.offsetLeft,
                tar_top_old = tar.offsetTop;

            changeIndex();

            var src_left_new = src.offsetLeft,
                src_top_new = src.offsetTop,
                tar_left_new = tar.offsetLeft,
                tar_top_new = tar.offsetTop;

            var src_left_t = src_left_old - src_left_new,
                src_top_t = src_top_old - src_top_new,
                tar_left_t = tar_left_old - tar_left_new,
                tar_top_t = tar_top_old - tar_top_new;

            /*var tar_nextsibling = tar.nextElementSibling,
                tar_presibling = tar.previousElementSibling;

            var src_top = src.offsetTop,
                src_left = src.offsetLeft,
                tar_top = tar.offsetTop,
                tar_left = tar.offsetLeft;

            if(tar_presibling !== null && tar_presibling !== undefined){
                var tar_pre_left = tar_presibling.offsetLeft,
                    tar_pre_top = tar_presibling.offsetTop;
            }

            if(tar_nextsibling !== null && tar_nextsibling !== undefined){
                var tar_next_left = tar_nextsibling.offsetLeft,
                    tar_next_top = tar_nextsibling.offsetTop;
            }  

            var src_translate_left = tar_left - src_left,
                src_translate_top = tar_top - src_top,
                tar_translate_left,
                tar_translate_top;

            if(src_index > tar_index){
                tar_translate_left = tar_next_left - tar_left;
                tar_translate_top = tar_next_top - tar_top;
            }else{
                tar_translate_left = tar_pre_left - tar_left;
                tar_translate_top = tar_pre_top - tar_top;
            }*/

            function transform(){
/*                src.classList.add('animate');
                tar.classList.add('animate');  */    
                src.style.transform = `translate(${src_left_t}px,${src_top_t}px)`;          
                tar.style.transform = `translate(${tar_left_t}px,${tar_top_t}px)`;
                src.classList.add('animate');
                tar.classList.add('animate');
                src.style.transform = `translate(0,0)`;
                tar.style.transform = `translate(0,0)`;
            }
            
            transform();
        //    clear_transform();

            var timer = setTimeout(function(){
                src.classList.remove('animate');
                tar.classList.remove('animate');
            },5000);

            function changeIndex(){
                if(src_index > tar_index){
                    parent.insertBefore(src,tar);
                }else if(src_index < tar_index){
                    insertAfter(src,tar);
                }
            }

            function clear_transform(){
                src.classList.add('animate');
                tar.classList.add('animate');
                src.style.transform = `translate(0,0)`;
                tar.style.transform = `translate(0,0)`;
            }

        }else{
            return false;
        }
       
    }

</script>
</html>